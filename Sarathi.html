<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SARATHI - Emergency Vehicle Navigation System</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <style>
        :root {
            --primary: #e74c3c;
            --secondary: #3498db;
            --success: #2ecc71;
            --warning: #f39c12;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --police: #3498db;
            --ambulance: #e74c3c;
            --fire: #f39c12;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: var(--dark);
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 30px;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .logo-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .logo-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .logo-text {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .auth-buttons {
            display: flex;
            gap: 10px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        .btn-outline {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
        }
        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        .card-title {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--dark);
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.2);
        }
        .vehicle-types {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }
        .vehicle-type {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .vehicle-type:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        .vehicle-type.selected {
            border-color: var(--primary);
            background: rgba(231, 76, 60, 0.1);
        }
        .vehicle-type i {
            font-size: 30px;
            margin-bottom: 10px;
            display: block;
        }
        .police {
            color: var(--police);
        }
        .ambulance {
            color: var(--ambulance);
        }
        .fire {
            color: var(--fire);
        }
        .map-container {
            height: 400px;
            background: #e0e0e0;
            border-radius: 15px;
            position: relative;
            overflow: hidden;
            margin-bottom: 20px;
        }
        #map {
            height: 100%;
            width: 100%;
            border-radius: 15px;
        }
        .route-inputs {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        .route-input {
            flex: 1;
            position: relative;
        }
        .route-input i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #888;
        }
        .route-input input {
            width: 100%;
            padding: 12px 15px 12px 40px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
        }
        .notification {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .notification-success {
            background: rgba(46, 204, 113, 0.2);
            color: var(--success);
            border-left: 5px solid var(--success);
        }
        .notification-info {
            background: rgba(52, 152, 219, 0.2);
            color: var(--secondary);
            border-left: 5px solid var(--secondary);
        }
        .notification-warning {
            background: rgba(243, 156, 18, 0.2);
            color: var(--warning);
            border-left: 5px solid var(--warning);
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            position: relative;
        }
        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #888;
        }
        .dashboard {
            display: none;
        }
        .dashboard.active {
            display: block;
        }
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        .stat-icon {
            font-size: 30px;
            margin-bottom: 10px;
        }
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        .stat-label {
            color: #888;
        }
        .sms-preview {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid var(--primary);
            margin-top: 20px;
            font-family: monospace;
        }
        .hidden {
            display: none;
        }
        .route-info {
            background: rgba(52, 152, 219, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
        }
        .route-stat {
            text-align: center;
        }
        .route-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--secondary);
        }
        .route-label {
            font-size: 12px;
            color: #666;
        }
        .location-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .traffic-station-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 15px;
        }
        .traffic-station {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .traffic-station:last-child {
            border-bottom: none;
        }
        .station-name {
            font-weight: 500;
        }
        .station-distance {
            color: #666;
            font-size: 14px;
        }
        .notification-status {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }
        .status-sent {
            background: rgba(46, 204, 113, 0.2);
            color: var(--success);
        }
        .status-pending {
            background: rgba(243, 156, 18, 0.2);
            color: var(--warning);
        }
        .directions-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }
        .direction-step {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 8px;
            background: white;
        }
        .direction-step.active {
            background: rgba(231, 76, 60, 0.1);
            border-left: 3px solid var(--primary);
        }
        .direction-icon {
            margin-right: 10px;
            color: var(--primary);
        }
        .direction-text {
            flex: 1;
        }
        .direction-distance {
            color: #666;
            font-size: 14px;
        }
        .street-view-container {
            position: relative;
            height: 300px;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 20px;
            display: none;
        }
        .street-view-container.active {
            display: block;
        }
        .street-view-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        .close-street-view {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 10;
        }
        .emergency-services {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .service-toggle {
            padding: 8px 12px;
            border-radius: 20px;
            background: #f0f0f0;
            border: none;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .service-toggle.active {
            background: var(--primary);
            color: white;
        }
        .traffic-alert {
            background: rgba(243, 156, 18, 0.1);
            border-left: 4px solid var(--warning);
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
            font-size: 14px;
        }
        @media (max-width: 768px) {
            .vehicle-types {
                flex-direction: column;
            }
            
            .route-inputs {
                flex-direction: column;
            }
            
            .location-controls {
                flex-direction: column;
            }
            
            .emergency-services {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon">
                    <img src="imge.jpg" alt="SARATHI Logo">
                </div>
                <div class="logo-text">SARATHI</div>
            </div>
            <div class="auth-buttons">
                <button class="btn btn-outline" id="loginBtn">Login</button>
                <button class="btn btn-primary" id="signupBtn">Sign Up</button>
            </div>
        </header>
        <!-- Login Modal -->
        <div class="modal" id="loginModal">
            <div class="modal-content">
                <span class="close-modal">&times;</span>
                <h2 class="card-title">Login to SARATHI</h2>
                <form id="loginForm">
                    <div class="form-group">
                        <input type="email" class="form-control" placeholder="Email" required>
                    </div>
                    <div class="form-group">
                        <input type="password" class="form-control" placeholder="Password" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
                </form>
            </div>
        </div>
        <!-- Signup Modal -->
        <div class="modal" id="signupModal">
            <div class="modal-content">
                <span class="close-modal">&times;</span>
                <h2 class="card-title">Sign Up for SARATHI</h2>
                <form id="signupForm">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Full Name" required>
                    </div>
                    <div class="form-group">
                        <input type="email" class="form-control" placeholder="Email" required>
                    </div>
                    <div class="form-group">
                        <input type="password" class="form-control" placeholder="Password" required>
                    </div>
                    <div class="form-group">
                        <input type="tel" class="form-control" placeholder="Phone Number" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Sign Up</button>
                </form>
            </div>
        </div>
        <!-- Dashboard -->
        <div class="dashboard" id="dashboard">
            <div class="notification notification-success">
                <i class="fas fa-check-circle"></i>
                <div>Welcome to SARATHI! Your emergency vehicle navigation system is ready.</div>
            </div>
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-icon police">
                        <i class="fas fa-car"></i>
                    </div>
                    <div class="stat-value" id="vehicleTypeDisplay">Police Van</div>
                    <div class="stat-label">Vehicle Type</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-id-card"></i>
                    </div>
                    <div class="stat-value" id="vehicleNumberDisplay">MH 01 AB 1234</div>
                    <div class="stat-label">Vehicle Number</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="stat-value" id="driverNameDisplay">John Doe</div>
                    <div class="stat-label">Driver Name</div>
                </div>
            </div>
            <div class="card">
                <h2 class="card-title">Route Navigation</h2>
                <div class="route-inputs">
                    <div class="route-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" class="form-control" placeholder="Starting Point" id="startPoint">
                    </div>
                    <div class="route-input">
                        <i class="fas fa-flag-checkered"></i>
                        <input type="text" class="form-control" placeholder="Destination" id="destination">
                    </div>
                </div>
                <div class="location-controls">
                    <button class="btn btn-outline" id="getCurrentLocation">
                        <i class="fas fa-location-arrow"></i> Use Current Location
                    </button>
                    <button class="btn btn-outline" id="setStartOnMap">
                        <i class="fas fa-map-pin"></i> Set Start on Map
                    </button>
                    <button class="btn btn-outline" id="setDestinationOnMap">
                        <i class="fas fa-map-pin"></i> Set Destination on Map
                    </button>
                    <button class="btn btn-outline" id="toggleStreetView">
                        <i class="fas fa-street-view"></i> Street View
                    </button>
                </div>
                <button class="btn btn-primary" id="startNavigation">Start Navigation</button>
                
                <div class="map-container">
                    <div id="map"></div>
                </div>
                
                <div class="street-view-container" id="streetViewContainer">
                    <button class="close-street-view" id="closeStreetView">
                        <i class="fas fa-times"></i>
                    </button>
                    <iframe class="street-view-iframe" id="streetViewIframe" src=""></iframe>
                </div>
                
                <div class="route-info hidden" id="routeInfo">
                    <div class="route-stat">
                        <div class="route-value" id="routeDistance">0 km</div>
                        <div class="route-label">Distance</div>
                    </div>
                    <div class="route-stat">
                        <div class="route-value" id="routeTime">0 min</div>
                        <div class="route-label">Est. Time</div>
                    </div>
                    <div class="route-stat">
                        <div class="route-value" id="routeTraffic">Normal</div>
                        <div class="route-label">Traffic</div>
                    </div>
                </div>
                
                <div class="directions-container hidden" id="directionsContainer">
                    <h3>Turn-by-Turn Directions</h3>
                    <div id="directionsList"></div>
                </div>
                
                <div id="trafficAlertContainer"></div>
            </div>
            <div class="card">
                <h2 class="card-title">Emergency Services</h2>
                <div class="emergency-services">
                    <button class="service-toggle active" data-service="tps">Traffic Police (TPS)</button>
                    <button class="service-toggle active" data-service="ps">Police Stations (PS)</button>
                    <button class="service-toggle active" data-service="fs">Fire Stations (FS)</button>
                    <button class="service-toggle active" data-service="hospital">Hospitals (+)</button>
                </div>
                
                <h2 class="card-title">Traffic Notification System</h2>
                <div class="notification notification-info">
                    <i class="fas fa-info-circle"></i>
                    <div>SMS notifications will be sent to nearby traffic police stations with your estimated arrival times.</div>
                </div>
                
                <div class="sms-preview">
                    <strong>EMERGENCY VEHICLE ALERT</strong><br>
                    Vehicle Type: <span id="smsVehicleType">Police Van</span><br>
                    Vehicle Number: <span id="smsVehicleNumber">MH 01 AB 1234</span><br>
                    Driver Name: <span id="smsDriverName">John Doe</span><br>
                    Estimated Arrival at Next Traffic Signal: <span id="eta">5 minutes</span><br>
                    Please clear the route for emergency passage.
                </div>
                
                <div class="traffic-station-list" id="trafficStationList">
                    <!-- Traffic stations will be populated here -->
                </div>
                
                <button class="btn btn-primary" style="margin-top: 20px;" id="sendNotifications">Send Notifications Now</button>
            </div>
        </div>
        <!-- Driver Details Form (shown after signup) -->
        <div class="card" id="driverDetailsForm">
            <h2 class="card-title">Driver & Vehicle Details</h2>
            <form id="driverForm">
                <div class="form-group">
                    <label for="driverName">Driver Name</label>
                    <input type="text" class="form-control" id="driverName" placeholder="Enter your full name" required>
                </div>
                
                <div class="form-group">
                    <label>Vehicle Type</label>
                    <div class="vehicle-types">
                        <div class="vehicle-type" data-type="police">
                            <i class="fas fa-shield-alt police"></i>
                            <div>Police Van</div>
                        </div>
                        <div class="vehicle-type" data-type="ambulance">
                            <i class="fas fa-ambulance ambulance"></i>
                            <div>Ambulance</div>
                        </div>
                        <div class="vehicle-type" data-type="fire">
                            <i class="fas fa-fire-extinguisher fire"></i>
                            <div>Fire Truck</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="vehicleNumber">Vehicle Number</label>
                    <input type="text" class="form-control" id="vehicleNumber" placeholder="Enter vehicle number" required>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%;">Save Details</button>
            </form>
        </div>
    </div>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet Routing Machine JS -->
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <script>
        // Navigation API Key
        const NAV_API_KEY = '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';
        
        // DOM Elements
        const loginBtn = document.getElementById('loginBtn');
        const signupBtn = document.getElementById('signupBtn');
        const loginModal = document.getElementById('loginModal');
        const signupModal = document.getElementById('signupModal');
        const dashboard = document.getElementById('dashboard');
        const driverDetailsForm = document.getElementById('driverDetailsForm');
        const driverForm = document.getElementById('driverForm');
        const loginForm = document.getElementById('loginForm');
        const signupForm = document.getElementById('signupForm');
        const closeModalButtons = document.querySelectorAll('.close-modal');
        const vehicleTypes = document.querySelectorAll('.vehicle-type');
        const startNavigationBtn = document.getElementById('startNavigation');
        const sendNotificationsBtn = document.getElementById('sendNotifications');
        const routeInfo = document.getElementById('routeInfo');
        const getCurrentLocationBtn = document.getElementById('getCurrentLocation');
        const setStartOnMapBtn = document.getElementById('setStartOnMap');
        const setDestinationOnMapBtn = document.getElementById('setDestinationOnMap');
        const trafficStationList = document.getElementById('trafficStationList');
        const toggleStreetViewBtn = document.getElementById('toggleStreetView');
        const streetViewContainer = document.getElementById('streetViewContainer');
        const closeStreetViewBtn = document.getElementById('closeStreetView');
        const streetViewIframe = document.getElementById('streetViewIframe');
        const directionsContainer = document.getElementById('directionsContainer');
        const directionsList = document.getElementById('directionsList');
        const trafficAlertContainer = document.getElementById('trafficAlertContainer');
        const serviceToggles = document.querySelectorAll('.service-toggle');
        
        // Map variables
        let map;
        let startMarker, endMarker, vehicleMarker;
        let routeControl;
        let settingStart = false;
        let settingDestination = false;
        let navigationActive = false;
        let vehiclePositionIndex = 0;
        let vehicleMovementInterval;
        let routeInstructions = [];
        let currentStepIndex = 0;
        
        // State
        let selectedVehicleType = '';
        let isLoggedIn = false;
        let driverDetails = {
            name: '',
            vehicleType: '',
            vehicleNumber: '',
            phone: ''
        };
        let routeCoordinates = [];
        
        // Emergency services data
        const emergencyServices = {
            tps: [
                { name: "Mumbai Central Traffic Police", lat: 19.0760, lng: 72.8777, phone: "+912222456789", type: "tps" },
                { name: "Andheri Traffic Control", lat: 19.1136, lng: 72.8697, phone: "+912222345678", type: "tps" },
                { name: "Bandra Traffic Division", lat: 19.0596, lng: 72.8295, phone: "+912222234567", type: "tps" },
                { name: "Powai Traffic Station", lat: 19.1177, lng: 72.9070, phone: "+912222123456", type: "tps" },
                { name: "Colaba Traffic Post", lat: 18.9067, lng: 72.8147, phone: "+912222012345", type: "tps" }
            ],
            ps: [
                { name: "Mumbai Central Police Station", lat: 19.0760, lng: 72.8777, phone: "+912222456789", type: "ps" },
                { name: "Andheri Police Station", lat: 19.1136, lng: 72.8697, phone: "+912222345678", type: "ps" },
                { name: "Bandra Police Station", lat: 19.0596, lng: 72.8295, phone: "+912222234567", type: "ps" },
                { name: "Powai Police Station", lat: 19.1177, lng: 72.9070, phone: "+912222123456", type: "ps" },
                { name: "Colaba Police Station", lat: 18.9067, lng: 72.8147, phone: "+912222012345", type: "ps" }
            ],
            fs: [
                { name: "Mumbai Central Fire Station", lat: 19.0760, lng: 72.8777, phone: "+912222456789", type: "fs" },
                { name: "Andheri Fire Station", lat: 19.1136, lng: 72.8697, phone: "+912222345678", type: "fs" },
                { name: "Bandra Fire Station", lat: 19.0596, lng: 72.8295, phone: "+912222234567", type: "fs" },
                { name: "Powai Fire Station", lat: 19.1177, lng: 72.9070, phone: "+912222123456", type: "fs" },
                { name: "Colaba Fire Station", lat: 18.9067, lng: 72.8147, phone: "+912222012345", type: "fs" }
            ],
            hospital: [
                { name: "Mumbai Central Hospital", lat: 19.0760, lng: 72.8777, phone: "+912222456789", type: "hospital" },
                { name: "Andheri Medical Center", lat: 19.1136, lng: 72.8697, phone: "+912222345678", type: "hospital" },
                { name: "Bandra General Hospital", lat: 19.0596, lng: 72.8295, phone: "+912222234567", type: "hospital" },
                { name: "Powai Emergency Hospital", lat: 19.1177, lng: 72.9070, phone: "+912222123456", type: "hospital" },
                { name: "Colaba Medical Facility", lat: 18.9067, lng: 72.8147, phone: "+912222012345", type: "hospital" }
            ]
        };
        
        // Vehicle icons for map
        const vehicleIcons = {
            police: 'ðŸš“',
            ambulance: 'ðŸš‘',
            fire: 'ðŸš’'
        };
        
        // Emergency service icons
        const serviceIcons = {
            tps: 'ðŸš¦',
            ps: 'ðŸ‘®',
            fs: 'ðŸ”¥',
            hospital: 'ðŸ¥'
        };
        
        // Event Listeners
        loginBtn.addEventListener('click', () => {
            loginModal.style.display = 'flex';
        });
        
        signupBtn.addEventListener('click', () => {
            signupModal.style.display = 'flex';
        });
        
        closeModalButtons.forEach(button => {
            button.addEventListener('click', () => {
                loginModal.style.display = 'none';
                signupModal.style.display = 'none';
            });
        });
        
        window.addEventListener('click', (e) => {
            if (e.target === loginModal) {
                loginModal.style.display = 'none';
            }
            if (e.target === signupModal) {
                signupModal.style.display = 'none';
            }
        });
        
        // Vehicle type selection
        vehicleTypes.forEach(type => {
            type.addEventListener('click', () => {
                vehicleTypes.forEach(t => t.classList.remove('selected'));
                type.classList.add('selected');
                selectedVehicleType = type.dataset.type;
            });
        });
        
        // Service toggle buttons
        serviceToggles.forEach(toggle => {
            toggle.addEventListener('click', () => {
                toggle.classList.toggle('active');
                updateEmergencyServicesOnMap();
            });
        });
        
        // Form submissions
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            // Simulate login with database
            const email = e.target.querySelector('input[type="email"]').value;
            const password = e.target.querySelector('input[type="password"]').value;
            
            // In a real app, this would be an API call to your backend
            simulateDatabaseLogin(email, password);
        });
        
        signupForm.addEventListener('submit', (e) => {
            e.preventDefault();
            // Simulate signup with database
            const name = e.target.querySelector('input[type="text"]').value;
            const email = e.target.querySelector('input[type="email"]').value;
            const password = e.target.querySelector('input[type="password"]').value;
            const phone = e.target.querySelector('input[type="tel"]').value;
            
            // In a real app, this would be an API call to your backend
            simulateDatabaseSignup(name, email, password, phone);
        });
        
        driverForm.addEventListener('submit', (e) => {
            e.preventDefault();
            // Save driver details
            driverDetails.name = document.getElementById('driverName').value;
            driverDetails.vehicleType = selectedVehicleType;
            driverDetails.vehicleNumber = document.getElementById('vehicleNumber').value;
            
            // Update dashboard with driver details
            updateDashboard();
            showDashboard();
        });
        
        getCurrentLocationBtn.addEventListener('click', () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        // Set the starting point input
                        document.getElementById('startPoint').value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                        
                        // Add marker to map
                        if (map) {
                            if (startMarker) map.removeLayer(startMarker);
                            startMarker = L.marker([lat, lng]).addTo(map)
                                .bindPopup('Your Current Location')
                                .openPopup();
                            map.setView([lat, lng], 15);
                        }
                    },
                    error => {
                        alert('Error getting your location: ' + error.message);
                    }
                );
            } else {
                alert('Geolocation is not supported by your browser');
            }
        });
        
        setStartOnMapBtn.addEventListener('click', () => {
            settingStart = true;
            settingDestination = false;
            alert('Click on the map to set the starting point');
        });
        
        setDestinationOnMapBtn.addEventListener('click', () => {
            settingDestination = true;
            settingStart = false;
            alert('Click on the map to set the destination');
        });
        
        toggleStreetViewBtn.addEventListener('click', () => {
            if (streetViewContainer.classList.contains('active')) {
                streetViewContainer.classList.remove('active');
            } else {
                if (vehicleMarker) {
                    const pos = vehicleMarker.getLatLng();
                    const streetViewUrl = `https://www.google.com/maps/embed?pb=!4v${Date.now()}!6m8!1m7!1sCAoSK0FGMVFpcE9tYzB5Q1R5M2N3R3l3UW1iQ3JtYXJ5N3FhQ1JqWEE.!2m2!1d${pos.lat}!2d${pos.lng}!3f0!4f0!5f0.7820865974627469`;
                    streetViewIframe.src = streetViewUrl;
                    streetViewContainer.classList.add('active');
                } else {
                    alert('Please start navigation first to use street view');
                }
            }
        });
        
        closeStreetViewBtn.addEventListener('click', () => {
            streetViewContainer.classList.remove('active');
        });
        
        startNavigationBtn.addEventListener('click', () => {
            if (navigationActive) {
                // Stop navigation
                stopNavigation();
                startNavigationBtn.textContent = 'Start Navigation';
                startNavigationBtn.classList.remove('btn-outline');
                startNavigationBtn.classList.add('btn-primary');
            } else {
                // Start navigation
                const startPoint = document.getElementById('startPoint').value;
                const destination = document.getElementById('destination').value;
                
                if (!startPoint || !destination) {
                    alert('Please enter both starting point and destination');
                    return;
                }
                
                // Parse coordinates or addresses
                const startCoords = parseCoordinates(startPoint);
                const destCoords = parseCoordinates(destination);
                
                if (!startCoords || !destCoords) {
                    alert('Please enter valid coordinates or addresses');
                    return;
                }
                
                // Show route
                showRoute(startCoords, destCoords);
                
                // Show route info
                routeInfo.classList.remove('hidden');
                directionsContainer.classList.remove('hidden');
                
                // Simulate ETA calculation
                const eta = Math.floor(Math.random() * 10) + 1; // Random ETA between 1-10 minutes
                document.getElementById('eta').textContent = `${eta} minutes`;
                
                // Simulate distance and time
                const distance = (Math.random() * 15 + 5).toFixed(1); // Random distance between 5-20 km
                const time = Math.floor(Math.random() * 20 + 10); // Random time between 10-30 min
                
                document.getElementById('routeDistance').textContent = `${distance} km`;
                document.getElementById('routeTime').textContent = `${time} min`;
                
                // Random traffic status
                const trafficStatus = ['Light', 'Normal', 'Heavy'][Math.floor(Math.random() * 3)];
                document.getElementById('routeTraffic').textContent = trafficStatus;
                
                // Find nearby traffic stations
                findNearbyTrafficStations(startCoords, destCoords);
                
                // Update button
                startNavigationBtn.textContent = 'Stop Navigation';
                startNavigationBtn.classList.remove('btn-primary');
                startNavigationBtn.classList.add('btn-outline');
                
                // Start vehicle movement simulation
                startVehicleMovement();
                
                // Show traffic alerts
                showTrafficAlerts();
            }
        });
        
        sendNotificationsBtn.addEventListener('click', () => {
            // Send notifications to all traffic stations in the list
            const stations = document.querySelectorAll('.traffic-station');
            let successCount = 0;
            
            stations.forEach(station => {
                const statusElement = station.querySelector('.notification-status');
                if (statusElement.classList.contains('status-pending')) {
                    // Simulate sending SMS
                    setTimeout(() => {
                        statusElement.textContent = 'Sent';
                        statusElement.classList.remove('status-pending');
                        statusElement.classList.add('status-sent');
                        successCount++;
                        
                        if (successCount === stations.length) {
                            // Show a success notification
                            const notification = document.createElement('div');
                            notification.className = 'notification notification-success';
                            notification.innerHTML = `
                                <i class="fas fa-check-circle"></i>
                                <div>Notifications sent successfully! Traffic police stations have been alerted.</div>
                            `;
                            
                            const parent = sendNotificationsBtn.parentNode;
                            parent.insertBefore(notification, sendNotificationsBtn.nextSibling);
                            
                            // Remove notification after 5 seconds
                            setTimeout(() => {
                                notification.remove();
                            }, 5000);
                        }
                    }, Math.random() * 2000); // Random delay to simulate sending
                }
            });
        });
        
        // Functions
        function showDashboard() {
            driverDetailsForm.classList.add('hidden');
            dashboard.classList.add('active');
            
            // Initialize map if not already done
            if (!map) {
                initMap();
            }
        }
        
        function updateDashboard() {
            // Update dashboard with driver details
            document.getElementById('driverNameDisplay').textContent = driverDetails.name;
            document.getElementById('vehicleNumberDisplay').textContent = driverDetails.vehicleNumber;
            
            let vehicleTypeText = '';
            switch(driverDetails.vehicleType) {
                case 'police':
                    vehicleTypeText = 'Police Van';
                    break;
                case 'ambulance':
                    vehicleTypeText = 'Ambulance';
                    break;
                case 'fire':
                    vehicleTypeText = 'Fire Truck';
                    break;
                default:
                    vehicleTypeText = 'Unknown';
            }
            
            document.getElementById('vehicleTypeDisplay').textContent = vehicleTypeText;
            
            // Update SMS preview
            document.getElementById('smsVehicleType').textContent = vehicleTypeText;
            document.getElementById('smsVehicleNumber').textContent = driverDetails.vehicleNumber;
            document.getElementById('smsDriverName').textContent = driverDetails.name;
        }
        
        // Initialize the map
        function initMap() {
            // Initialize the map centered on Mumbai
            map = L.map('map').setView([19.0760, 72.8777], 13);
            
            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            // Add click event to map
            map.on('click', function(e) {
                if (settingStart) {
                    // Set start point
                    const lat = e.latlng.lat;
                    const lng = e.latlng.lng;
                    
                    document.getElementById('startPoint').value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                    
                    if (startMarker) map.removeLayer(startMarker);
                    startMarker = L.marker([lat, lng]).addTo(map)
                        .bindPopup('Starting Point')
                        .openPopup();
                    
                    settingStart = false;
                } else if (settingDestination) {
                    // Set destination
                    const lat = e.latlng.lat;
                    const lng = e.latlng.lng;
                    
                    document.getElementById('destination').value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                    
                    if (endMarker) map.removeLayer(endMarker);
                    endMarker = L.marker([lat, lng]).addTo(map)
                        .bindPopup('Destination')
                        .openPopup();
                    
                    settingDestination = false;
                }
            });
            
            // Add a marker for current location (simulated)
            L.marker([19.0760, 72.8777])
                .addTo(map)
                .bindPopup('Current Location')
                .openPopup();
                
            // Add emergency services to map
            updateEmergencyServicesOnMap();
        }
        
        // Update emergency services on map based on toggles
        function updateEmergencyServicesOnMap() {
            // Clear existing service markers
            map.eachLayer(layer => {
                if (layer.options && layer.options.isEmergencyService) {
                    map.removeLayer(layer);
                }
            });
            
            // Add markers for active services
            serviceToggles.forEach(toggle => {
                if (toggle.classList.contains('active')) {
                    const serviceType = toggle.dataset.service;
                    const services = emergencyServices[serviceType];
                    
                    services.forEach(service => {
                        const icon = serviceIcons[serviceType];
                        const marker = L.marker([service.lat, service.lng], {
                            icon: L.divIcon({
                                className: 'emergency-service-marker',
                                html: `<div style="font-size: 24px;">${icon}</div>`,
                                iconSize: [30, 30],
                                iconAnchor: [15, 15]
                            }),
                            isEmergencyService: true
                        }).addTo(map).bindPopup(service.name);
                    });
                }
            });
        }
        
        // Parse coordinates from string
        function parseCoordinates(coordString) {
            // Check if it's in "lat, lng" format
            const parts = coordString.split(',');
            if (parts.length === 2) {
                const lat = parseFloat(parts[0].trim());
                const lng = parseFloat(parts[1].trim());
                
                if (!isNaN(lat) && !isNaN(lng)) {
                    return [lat, lng];
                }
            }
            
            // In a real app, you would use a geocoding service here
            return null;
        }
        
        // Show route on map
        function showRoute(start, end) {
            // Remove existing markers and route
            if (startMarker) map.removeLayer(startMarker);
            if (endMarker) map.removeLayer(endMarker);
            if (routeControl) map.removeControl(routeControl);
            if (vehicleMarker) map.removeLayer(vehicleMarker);
            
            // Add markers
            startMarker = L.marker(start).addTo(map).bindPopup('Start');
            endMarker = L.marker(end).addTo(map).bindPopup('Destination');
            
            // Add vehicle marker at start position
            const vehicleIcon = vehicleIcons[driverDetails.vehicleType] || 'ðŸš—';
            vehicleMarker = L.marker(start, {
                icon: L.divIcon({
                    className: 'vehicle-marker',
                    html: `<div style="font-size: 30px;">${vehicleIcon}</div>`,
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                })
            }).addTo(map).bindPopup('Emergency Vehicle');
            
            // Add routing control
            routeControl = L.Routing.control({
                waypoints: [
                    L.latLng(start[0], start[1]),
                    L.latLng(end[0], end[1])
                ],
                routeWhileDragging: false,
                createMarker: function() { return null; }, // Don't create additional markers
                lineOptions: {
                    styles: [{ color: '#e74c3c', weight: 4, opacity: 0.7 }]
                }
            }).addTo(map);
            
            // Store route coordinates for later use
            routeControl.on('routesfound', function(e) {
                const routes = e.routes;
                const summary = routes[0].summary;
                
                // Update route info
                document.getElementById('routeDistance').textContent = `${(summary.totalDistance / 1000).toFixed(1)} km`;
                document.getElementById('routeTime').textContent = `${Math.round(summary.totalTime / 60)} min`;
                
                // Store route coordinates
                routeCoordinates = routes[0].coordinates;
                
                // Store route instructions
                routeInstructions = routes[0].instructions;
                displayDirections();
            });
            
            // Fit the map to show the entire route
            map.fitBounds([start, end]);
        }
        
        // Display turn-by-turn directions
        function displayDirections() {
            directionsList.innerHTML = '';
            
            routeInstructions.forEach((instruction, index) => {
                const stepElement = document.createElement('div');
                stepElement.className = 'direction-step';
                if (index === currentStepIndex) {
                    stepElement.classList.add('active');
                }
                
                stepElement.innerHTML = `
                    <div class="direction-icon">
                        <i class="fas fa-${getDirectionIcon(instruction.type)}"></i>
                    </div>
                    <div class="direction-text">${instruction.text}</div>
                    <div class="direction-distance">${(instruction.distance / 1000).toFixed(1)} km</div>
                `;
                
                directionsList.appendChild(stepElement);
            });
        }
        
        // Get direction icon based on instruction type
        function getDirectionIcon(type) {
            switch(type) {
                case 'Straight': return 'arrow-up';
                case 'SlightRight': return 'arrow-right';
                case 'Right': return 'arrow-right';
                case 'SharpRight': return 'arrow-right';
                case 'TurnAround': return 'undo';
                case 'SharpLeft': return 'arrow-left';
                case 'Left': return 'arrow-left';
                case 'SlightLeft': return 'arrow-left';
                case 'Waypoint': return 'map-marker-alt';
                case 'Roundabout': return 'sync-alt';
                default: return 'arrow-up';
            }
        }
        
        // Start vehicle movement simulation
        function startVehicleMovement() {
            navigationActive = true;
            vehiclePositionIndex = 0;
            currentStepIndex = 0;
            
            // Clear any existing interval
            if (vehicleMovementInterval) {
                clearInterval(vehicleMovementInterval);
            }
            
            // Move vehicle along the route
            vehicleMovementInterval = setInterval(() => {
                if (vehiclePositionIndex < routeCoordinates.length - 1) {
                    vehiclePositionIndex++;
                    const newPosition = routeCoordinates[vehiclePositionIndex];
                    
                    // Update vehicle marker position
                    vehicleMarker.setLatLng(newPosition);
                    
                    // Update street view if active
                    if (streetViewContainer.classList.contains('active')) {
                        const streetViewUrl = `https://www.google.com/maps/embed?pb=!4v${Date.now()}!6m8!1m7!1sCAoSK0FGMVFpcE9tYzB5Q1R5M2N3R3l3UW1iQ3JtYXJ5N3FhQ1JqWEE.!2m2!1d${newPosition.lat}!2d${newPosition.lng}!3f0!4f0!5f0.7820865974627469`;
                        streetViewIframe.src = streetViewUrl;
                    }
                    
                    // Update current step in directions
                    updateCurrentStep();
                    
                    // Check if we've reached the destination
                    if (vehiclePositionIndex === routeCoordinates.length - 1) {
                        stopNavigation();
                        alert('You have reached your destination!');
                    }
                } else {
                    stopNavigation();
                }
            }, 1000); // Update position every second
        }
        
        // Stop navigation
        function stopNavigation() {
            navigationActive = false;
            if (vehicleMovementInterval) {
                clearInterval(vehicleMovementInterval);
            }
            
            // Update button
            startNavigationBtn.textContent = 'Start Navigation';
            startNavigationBtn.classList.remove('btn-outline');
            startNavigationBtn.classList.add('btn-primary');
        }
        
        // Update current step in directions
        function updateCurrentStep() {
            // Find the current step based on vehicle position
            // This is a simplified version - in a real app, you would calculate this more accurately
            const progress = vehiclePositionIndex / routeCoordinates.length;
            const newStepIndex = Math.floor(progress * routeInstructions.length);
            
            if (newStepIndex !== currentStepIndex && newStepIndex < routeInstructions.length) {
                currentStepIndex = newStepIndex;
                
                // Update active step in UI
                const steps = document.querySelectorAll('.direction-step');
                steps.forEach((step, index) => {
                    if (index === currentStepIndex) {
                        step.classList.add('active');
                    } else {
                        step.classList.remove('active');
                    }
                });
                
                // Show notification for the current step
                const currentInstruction = routeInstructions[currentStepIndex];
                showDirectionNotification(currentInstruction);
            }
        }
        
        // Show direction notification
        function showDirectionNotification(instruction) {
            const notification = document.createElement('div');
            notification.className = 'notification notification-info';
            notification.innerHTML = `
                <i class="fas fa-directions"></i>
                <div>${instruction.text} in ${(instruction.distance / 1000).toFixed(1)} km</div>
            `;
            
            // Add notification to the top of the dashboard
            const dashboardElement = document.getElementById('dashboard');
            dashboardElement.insertBefore(notification, dashboardElement.firstChild);
            
            // Remove notification after 5 seconds
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }
        
        // Show traffic alerts
        function showTrafficAlerts() {
            // Clear existing alerts
            trafficAlertContainer.innerHTML = '';
            
            // Simulate traffic alerts
            const hasTraffic = Math.random() > 0.5; // 50% chance of traffic
            
            if (hasTraffic) {
                const delay = Math.floor(Math.random() * 10) + 5; // 5-15 minutes delay
                const trafficAlert = document.createElement('div');
                trafficAlert.className = 'traffic-alert';
                trafficAlert.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Traffic Alert:</strong> Heavy traffic detected ahead. Estimated delay: ${delay} minutes.
                `;
                
                trafficAlertContainer.appendChild(trafficAlert);
                
                // Update ETA
                const currentEta = parseInt(document.getElementById('eta').textContent);
                document.getElementById('eta').textContent = `${currentEta + delay} minutes`;
                
                // Update route time
                const currentTime = parseInt(document.getElementById('routeTime').textContent);
                document.getElementById('routeTime').textContent = `${currentTime + delay} min`;
                
                // Update traffic status
                document.getElementById('routeTraffic').textContent = 'Heavy';
            }
        }
        
        // Find nearby traffic stations
        function findNearbyTrafficStations(start, end) {
            // Clear previous list
            trafficStationList.innerHTML = '';
            
            // Calculate the route center
            const center = [(start[0] + end[0]) / 2, (start[1] + end[1]) / 2];
            
            // Find stations within 5km of the route
            const nearbyStations = emergencyServices.tps.filter(station => {
                // Calculate distance from station to route center (simplified)
                const distance = calculateDistance(center[0], center[1], station.lat, station.lng);
                return distance < 5; // Within 5km
            });
            
            // Add stations to the list
            nearbyStations.forEach(station => {
                const stationElement = document.createElement('div');
                stationElement.className = 'traffic-station';
                
                const distance = calculateDistance(center[0], center[1], station.lat, station.lng);
                
                stationElement.innerHTML = `
                    <div>
                        <div class="station-name">${station.name}</div>
                        <div class="station-distance">${distance.toFixed(1)} km away</div>
                    </div>
                    <div class="notification-status status-pending">Pending</div>
                `;
                
                trafficStationList.appendChild(stationElement);
                
                // Add marker to map if TPS toggle is active
                const tpsToggle = document.querySelector('[data-service="tps"]');
                if (tpsToggle.classList.contains('active')) {
                    L.marker([station.lat, station.lng], {
                        icon: L.divIcon({
                            className: 'emergency-service-marker',
                            html: `<div style="font-size: 24px;">${serviceIcons.tps}</div>`,
                            iconSize: [30, 30],
                            iconAnchor: [15, 15]
                        }),
                        isEmergencyService: true
                    }).addTo(map).bindPopup(station.name);
                }
            });
            
            if (nearbyStations.length === 0) {
                trafficStationList.innerHTML = '<div class="notification notification-info">No traffic police stations found near your route.</div>';
            }
        }
        
        // Calculate distance between two points (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of the earth in km
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            const distance = R * c; // Distance in km
            return distance;
        }
        
        function deg2rad(deg) {
            return deg * (Math.PI/180);
        }
        
        // Simulate database login
        function simulateDatabaseLogin(email, password) {
            // In a real app, this would be an API call to your backend
            // which would check the credentials against a MySQL database
            
            // Simulate successful login
            setTimeout(() => {
                isLoggedIn = true;
                loginModal.style.display = 'none';
                
                // Check if driver details exist
                if (driverDetails.name && driverDetails.vehicleType && driverDetails.vehicleNumber) {
                    showDashboard();
                } else {
                    driverDetailsForm.classList.remove('hidden');
                }
            }, 1000);
        }
        
        // Simulate database signup
        function simulateDatabaseSignup(name, email, password, phone) {
            // In a real app, this would be an API call to your backend
            // which would store the user in a MySQL database
            
            // Store phone number for driver details
            driverDetails.phone = phone;
            
            // Simulate successful signup
            setTimeout(() => {
                isLoggedIn = true;
                signupModal.style.display = 'none';
                driverDetailsForm.classList.remove('hidden');
            }, 1000);
        }
        
        // Initialize the app
        function init() {
            // Check if user is logged in (in a real app, this would check session/cookie)
            if (isLoggedIn) {
                if (driverDetails.name && driverDetails.vehicleType && driverDetails.vehicleNumber) {
                    showDashboard();
                } else {
                    driverDetailsForm.classList.remove('hidden');
                }
            }
        }
        
        init();
    </script>
</body>
</html>